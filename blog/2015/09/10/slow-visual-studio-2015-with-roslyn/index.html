<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="lunet 0.5.0.0">
    <title>Slow Visual Studio 2015 on large projects | xoofx</title>
    <link rel="stylesheet" href="/css/site.css">
    <script src="/js/site-defer.js" defer></script>
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@xoofx">
    <meta name="twitter:title" content="Slow Visual Studio 2015 on large projects | xoofx">
    <meta name="twitter:description" content="xoofx website">
    <meta name="twitter:image" content="https://xoofx.com/images/twitter-banner.png">
    <meta name="twitter:image:alt" content="Slow Visual Studio 2015 on large projects | xoofx">    
    <script src="https://www.googletagmanager.com/gtag/js?id=G-0DVR9ML8KY" async></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-0DVR9ML8KY');</script>
  </head>
  <body>

  <div class="container">
    <div class="row">
      <nav class="navbar navbar-expand-md navbar-light w-100">
            <a class="xoofx-logo navbar-brand" href="/"></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
            </button>
            <div id="navbarSupportedContent" class="collapse navbar-collapse justify-content-between">
<ol id='nav-id-home-0' class='navbar-nav nav-level0  w-100'>
  <li class='nav-item '>
    <span class='nav-item-row'><a href='/' class='nav-link  '>Home</a></span>  </li>
  <li class='nav-item  active'>
    <span class='nav-item-row'><a href='/blog/' class='nav-link  '>Blog</a></span>  </li>
  <li class='nav-item '>
    <span class='nav-item-row'><a href='/projects/' class='nav-link  '>Projects</a></span>  </li>
  <li class='nav-item  ml-auto'>
    <span class='nav-item-row'><a href='/about/' class='nav-link  '>About</a></span>  </li>
</ol>
            </div>            
      </nav>
    </div>
    <div class="row">
      
      <div class="col-sm-9 js-toc-content">
        <p id="lunet-results"></p>
        <article class="page">
          <div class="title">
      		  <h1 class="title"><a href="/blog/2015/09/10/slow-visual-studio-2015-with-roslyn/">Slow Visual Studio 2015 on large projects</a></h1>
      		
          </div>
          <div class="entry-content">
          <div class="blog-post-meta">
            <span class="fa fa-calendar"></span>
            <span class="date"><time datetime="2015-09-10" itemprop="datePublished">September 10, 2015</time></span>
            <i class="fa fa-tags"></i><a href="/blog/tag/visual-studio-2015/">Visual Studio 2015</a>, <a href="/blog/tag/roslyn/">Roslyn</a>
        	  <span class="fa fa-edit"></span> <a href="https://github.com/xoofx/xoofx.github.io/edit/master/blog/2015/2015-09-10-slow-visual-studio-2015-with-roslyn.md">edit</a>
          </div>
            <blockquote>
            <p><strong>Update 10 October 2015</strong>: I just tried the Hotfix KBs mentioned in the <a href="http://blogs.msdn.com/b/maoni/archive/2015/08/12/gen2-free-list-changes-in-clr-4-6-gc.aspx?wa=wsignin1.0#10646095">comment from Lee Coward
            7 Oct 2015 3:02 AM </a> and it seems to fix the issue detailed in this post!</p>
            <p>It actually confirms that the issue was related to this bug in the GC.</p>
            <p><strong>You can remove the registry key patch that was most likely unrelated!</strong></p>
            </blockquote>
            <p>At work, we have switched to VS2015 and have been experiencing so far lots of &quot;Visual Studio Not Responding&quot; while editing the code. I first thought that it was ReSharper crawling VS. Then I tried to disable almost all extensions, but still while typing into a C# file, sometimes VS could get stuck for more than 10+ seconds!</p>
            <p>Digging a bit more into this problem with xperf (with the shiny new WPR and WPA tools from Windows 10 SDK!) I discovered that it was mainly due to the GC (and maybe Roslyn) burning the CPU and the memory (If you are a C++ programmer, you can laugh at it, for sure). Here is a screenshot of the xperf report:</p>
            <a href="/images/VS2015_Roslyn_GC.jpg" title="Result of a xperf on a Visual Studio 2015 not responding" class="image-popup">
            	<img src="/images/VS2015_Roslyn_GC.jpg">			
            </a>
            <p>You can see on the diagram that the GC is blocked in a <code>gc_heap/gc1</code> phase, while there is no particular reason for that. Also when you look more closely at the diagram, it is occupying a full core for more than 20+ seconds.</p>
            <p>I was wondering why the hell the GC is triggered even if I don't see to modify heavily the memory (even if Roslyn can be memory consuming, come on...), so I looked at the Roslyn repo to find out any explicit GC handling and found this code in <a href="https://github.com/dotnet/roslyn/blob/master/src/VisualStudio/Core/Def/Implementation/GCManager.cs#L61">GCManager</a>:</p>
            <p>Every 5 seconds you stop typing into a file, this code is triggered:</p>
            <pre><code class="language-csharp">    // hint to the GC that if it postponed a gen 2 collection, now might be a good time to do it.
                GC.Collect(2, GCCollectionMode.Optimized);
            </code></pre>
            <p>Basically, Roslyn is putting the GC in the <code>SustainedLowLatency</code> mode whenever you type a character/cut/paste modify the current document, and restore the normal GC mode after 5 seconds and perform this optimized collect. I was quite intrigued by this (and not sure about how the <code>GCCollectionMode.Optimized</code> is actually working internally...), but it turns out that you can disable this behaviour via a single registry key:</p>
            <pre><code>[HKEY_CURRENT_USER\Software\Microsoft\VisualStudio\14.0\Performance]
            &quot;SustainedLowLatencyDuration&quot;=dword:00000000
            </code></pre>
            <p>I don't know if it is a placebo effect, but I'm getting a bit less &quot;Not Responding&quot; from VS2015 for the past few days. At least, I'm not completely stuck, as last Friday, It was impossible for me to work. But one of my co-worker that is having the same problem tried the registry trick but it didn't seem to make a difference... Sadly also, I tried to reproduce this issue with a plain C# app without any luck so... most likely because the memory scenario that is causing this GC slowness is not easily reproducible.</p>
            <p>But it looks like there is a bug somewhere in Visual Studio 2015 with the GC... Incidentally, someone on the MVP mailing list was complaining about a bug in the GC of .NET 4.6 that was slowing down its app by a factor of x10, and I completely forgot this issue that I saw a couple of weeks ago : &quot;<a href="http://blogs.msdn.com/b/maoni/archive/2015/08/12/gen2-free-list-changes-in-clr-4-6-gc.aspx">Gen2 free list changes in CLR 4.6 GC</a>&quot;.</p>
            <p><strong>Could it be that it is in fact the original bug that is making our VS2015 experience so painful and horrible?</strong></p>
            <p>My wild guess: Roslyn Syntax Trees are more likely to end-up quickly in a Gen2 memory section, while editing a single file (or doing a refactoring on many different files), with the immutable architecture of Roslyn, would cause to sparsely un-reference some objects from Gen2... the GC could then hit the bug described above... Anyway, hope that the VS/CLR team can solve this quickly!</p>
            <p>Are you experiencing this kind of issues as well? Let me know!</p>
            <hr />
            <h3 id="side-notes-about-resharper-and-roslyn">Side notes about ReSharper and Roslyn</h3>
            <p>On a side note, I was not really happy to learn last year that ReSharper would not consider to rely on Roslyn to build their productivity tool, as I was afraid about the double of work.</p>
            <p>It is quite confirmed by Visual Studio 2015: When using ReSharper, the memory goes from 500Mo VS2015 to a whopping 1.2Go on our project. The problem with the GC described above is getting worse in this scenario also.</p>
            <p>ReSharper said that they didn't want to rewrite their whole code/tests for it, something that I can understand... But whenever someone will built powerful additions (navigation, refactor, code gen) on top of Roslyn (and it is now quite easier with it) I will most likely switch to it, as there is no doubt that it will save lots of memory and it will be faster.</p>
      
          </div>
        </article>
      </div>
      <div class="col-sm-3">
        <nav class="js-toc toc sticky-top"></nav>
      </div>
    </div>
  </div>
	<footer class="blog-footer">
        <p>Copyright &copy; 2009 - 2023, Alexandre Mutel - Blog content licensed under the Creative Commons <a href="http://creativecommons.org/licenses/by/2.5/">CC BY 2.5</a> | Site powered by <a href="https://github.com/lunet-io/lunet">lunet</a></p>
	</footer>  </body>
</html>